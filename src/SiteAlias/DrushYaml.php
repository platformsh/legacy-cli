<?php

declare(strict_types=1);

namespace Platformsh\Cli\SiteAlias;

use Platformsh\Client\Model\Project;
use Symfony\Component\Yaml\Yaml;

class DrushYaml extends DrushAlias
{
    /**
     * {@inheritdoc}
     */
    protected function getFilename(string $groupName): string
    {
        return $this->drush->getSiteAliasDir() . '/' . $groupName . '.site.yml';
    }

    /**
     * {@inheritdoc}
     */
    protected function formatAliases(array $aliases): string
    {
        return Yaml::dump($aliases, 5, 2);
    }

    /**
     * {@inheritdoc}
     */
    protected function getExistingAliases(string $currentGroup, $previousGroup = null): array
    {
        $aliases = parent::getExistingAliases($currentGroup, $previousGroup);
        if (empty($aliases)) {
            foreach (array_filter([$currentGroup, $previousGroup]) as $groupName) {
                $filename = $this->getFilename($groupName);
                if (file_exists($filename) && ($content = file_get_contents($filename))) {
                    $aliases = array_merge($aliases, (array) Yaml::parse($content));
                }
            }
        }

        return $aliases;
    }

    /**
     * {@inheritdoc}
     */
    protected function normalize(array $aliases): array
    {
        return $this->swapKeys($aliases, [
            'remote-host' => 'host',
            'remote-user' => 'user',
        ]);
    }

    /**
     * {@inheritdoc}
     */
    protected function getHeader(Project $project): string
    {
        return <<<EOT
            # Drush aliases for the {$this->config->getStr('service.name')} project "{$project->title}".
            # This file is auto-generated by the {$this->config->getStr('application.name')}.
            #
            # WARNING
            # This file may be regenerated at any time.
            # - User-defined aliases will be preserved.
            # - Aliases for active environments (including any custom additions) will be preserved.
            # - Aliases for deleted or inactive environments will be deleted.
            # - All other information will be deleted.
            EOT;
    }
}
